services:
  # PostgreSQL - Zentrale Datenbank
  postgres:
    image: postgres:16-alpine
    container_name: automation-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-automation}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-automation}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-automation} -d ${POSTGRES_DB:-automation}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - automation-network

  # Flyway - Datenbank-Migrationen
  flyway:
    image: flyway/flyway:latest
    container_name: automation-flyway
    command: migrate
    environment:
      FLYWAY_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-automation}
      FLYWAY_USER: ${POSTGRES_USER:-automation}
      FLYWAY_PASSWORD: ${POSTGRES_PASSWORD}
      FLYWAY_SCHEMAS: public
      FLYWAY_BASELINE_ON_MIGRATE: "true"
      FLYWAY_VALIDATE_MIGRATION_NAMING: "true"
    volumes:
      - ./migrations:/flyway/sql:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - automation-network

  # NocoDB - Datenbank-Frontend (Airtable-Alternative)
  nocodb:
    image: nocodb/nocodb:latest
    container_name: automation-nocodb
    restart: unless-stopped
    environment:
      NC_DB: "pg://postgres:5432?u=${POSTGRES_USER:-automation}&p=${POSTGRES_PASSWORD}&d=nocodb"
      NC_AUTH_JWT_SECRET: ${NOCODB_JWT_SECRET:?NOCODB_JWT_SECRET is required}
      NC_PUBLIC_URL: ${NOCODB_PUBLIC_URL:-http://localhost:8080}
    volumes:
      - nocodb_data:/usr/app/data
    ports:
      - "${NOCODB_PORT:-8080}:8080"
    depends_on:
      flyway:
        condition: service_completed_successfully
    networks:
      - automation-network

  # n8n - Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: automation-n8n
    restart: unless-stopped
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-automation}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:?N8N_ENCRYPTION_KEY is required}
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://localhost:5678}
      GENERIC_TIMEZONE: ${TIMEZONE:-Europe/Berlin}
    volumes:
      - n8n_data:/home/node/.n8n
    ports:
      - "${N8N_PORT:-5678}:5678"
    depends_on:
      flyway:
        condition: service_completed_successfully
    networks:
      - automation-network

  # Metabase - Analytics und Reporting
  metabase:
    image: metabase/metabase:latest
    container_name: automation-metabase
    restart: unless-stopped
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: ${POSTGRES_USER:-automation}
      MB_DB_PASS: ${POSTGRES_PASSWORD}
      MB_DB_HOST: postgres
      MB_ENCRYPTION_SECRET_KEY: ${METABASE_SECRET_KEY:?METABASE_SECRET_KEY is required}
      JAVA_TIMEZONE: ${TIMEZONE:-Europe/Berlin}
    volumes:
      - metabase_data:/metabase-data
    ports:
      - "${METABASE_PORT:-3000}:3000"
    depends_on:
      flyway:
        condition: service_completed_successfully
    networks:
      - automation-network

  # Uptime Kuma - Monitoring und Alerting
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: automation-uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime_kuma_data:/app/data
    ports:
      - "${UPTIME_KUMA_PORT:-3001}:3001"
    networks:
      - automation-network

volumes:
  postgres_data:
    name: automation-postgres-data
  nocodb_data:
    name: automation-nocodb-data
  n8n_data:
    name: automation-n8n-data
  metabase_data:
    name: automation-metabase-data
  uptime_kuma_data:
    name: automation-uptime-kuma-data

networks:
  automation-network:
    name: automation-network
    driver: bridge
